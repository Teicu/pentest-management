<?php
/**
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */

namespace App\Console\Commands;

use App\AdminNotice;
use App\Project;
use App\Task\BatchProcessSubdomainsFoundViaCTFR;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\File;
use Symfony\Component\Process\Process;

class ctfr extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'ctfr:scan
    {--project=0 : Project ID}
    {--domain=2 : Domain without http(s) or slashes}';

    /**
     * @var
     */
    protected $project;

    /**
     * @var string
     */
    protected $cmd = "";

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Perform a subdomain enumeration using ctfr and axfr technique';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return mixed
     */
    public function handle()
    {
        list($projectId, $domain) = $this->getArguments();


        $this->validateArguments($projectId, $domain);


        $this->project = Project::findOrFail($projectId);

        $outputPath = $this->makeOutputFileAndPath($domain, $projectId);

        $this->cmd = $this->createCommand($domain, $outputPath);

        $this->line("Executed command: " . $this->cmd);

        AdminNotice::create([
            'type'    => 'success',
            'context' => "ctfr:scan",
            'message' => "Execution started",
            'cmd'     => $this->cmd,
        ]);

        $this->executeCommand($this->cmd);

        $this->checkIfReportWasCreated($outputPath);

        $this->importCTFRDataToDB($outputPath);


        $message = "Process finished, report saved to file and database.";
        $this->info($message);

        AdminNotice::create([
            'type'    => 'success',
            'context' => 'ctfr:scan',
            'message' => $message,
            'cmd'     => $this->cmd,
        ]);
    }

    /**
     * @return array
     */
    protected function getArguments(): array
    {
        $projectId = $this->option("project");
        $domain = $this->option("domain");

        return [$projectId, $domain];
    }

    /**
     * @param $projectId
     * @param $domain
     * @param $interval
     * @param $wordlist
     * @param $resolver
     */
    protected function validateArguments(int $projectId, string $domain)
    {
        $message = "";
        $abort = false;

        if ($projectId <= 0) {
            $abort = true;
            $message = "projectId has to be bigger than 0";
        }

        if (strlen($domain) < 4) {
            $abort = true;
            $message = "domain not set or too small";
        }

        if ($abort) {
            $this->error($message);

            AdminNotice::create([
                'type'    => 'error',
                'context' => "ctfr:scan",
                'message' => $message,
                'cmd'     => $this->cmd,
            ]);

            exit();

        }
    }

    /**
     * @param string $domain
     * @param int    $projectId
     *
     * @return string
     */
    protected function makeOutputFileAndPath(string $domain, int $projectId): string
    {
        $outputFile = str_slug($domain) . "-" . $projectId . ".txt";
        $outputPath = storage_path("app/public/ctfr/" . $outputFile);

        return $outputPath;
    }

    /**
     * @param string $domain
     * @param string $outputPath
     *
     * @return string
     */
    protected function createCommand(string $domain, string $outputPath): string
    {
        $cmd = [];
        $cmd[] = config('toolset.bin.python3');
        $cmd[] = config("toolset.path.ctfr");
        $cmd[] = "-d " . $domain;
        $cmd[] = "-o " . $outputPath;

        $cmd = implode(" ", $cmd);

        return $cmd;
    }

    /**
     * @param $cmd
     */
    protected function executeCommand(string $cmd): void
    {
        $process = new Process($cmd);

        $process->setTimeout(
            config("toolset.ctfr.timeout")
        );
        $process->disableOutput();
        $process->run();

    }

    /**
     * @param string $outputPath
     */
    protected function checkIfReportWasCreated(string $outputPath): void
    {
        if (!File::exists($outputPath)) {
            $message = "Failed importing report... no report found";

            $this->warn($message);

            AdminNotice::create([
                'type'    => 'warning',
                'context' => 'ctfr:scan',
                'message' => $message,
                'cmd'     => $this->cmd,
            ]);

            exit();
        }
    }

    /**
     * @param string $outputPath
     */
    protected function importCTFRDataToDB(string $outputPath): void
    {
        $subdomains = File::get($outputPath);
        $domainAdder = new BatchProcessSubdomainsFoundViaCTFR();
        $domainAdder->setProject($this->project);
        $domainAdder->start($subdomains);
    }
}
